import { Response } from '@angular/http';
import { Observable }     from 'rxjs/Observable';
import { Oauth2AccessToken } from './oauth2.access-token';
import { Oauth2Service , Oauth2TokenEvent} from '../oauth2.service';
import { Http, Headers } from '@angular/http';

export class Oauth2Profile {
    private profile = {};
    constructor(private oauthService: Oauth2Service , private accessToken: Oauth2AccessToken, private http: Http) {
        Oauth2Service.Authorized.subscribe(
            (item: Oauth2TokenEvent) => {
                let conf = oauthService.getCurrentConfig();
                this.loadProfile(conf);
            }
        );
    }

    public loadProfile(config: any) {
        let profile = Oauth2Service.getStorage().getJson(Oauth2Service.STORAGE_KEY_PROFILE);
        if (profile) {
            this.profile = profile;
            Oauth2Service.Profile.emit({profile: this.profile});
        } else if (config.profileUri && this.accessToken.get() && this.accessToken.get().access_token) {
            let headers = new Headers();
            headers.append('Authorization', 'Bearer ' + this.oauthService.getToken().get().access_token);
            console.log(headers);
            this.http.get(config.profileUri, {headers: headers})
                .subscribe(
                    (data) => this.handleProfile(data),
                    (err) => this.handleProfileError(err),
                    () => Oauth2Service.Profile.emit({profile: this.profile})
                );
        }
    }

    public getProfile() {
        return this.profile;
    }

    private handleProfile(res: Response) {
        this.profile = res.json();
        Oauth2Service.getStorage().setJson(Oauth2Service.STORAGE_KEY_PROFILE, this.profile);
        return res;
    }

    private handleProfileError(error: any) {
        console.log(error);
        let errMsg = (error.message) ? error.message : error.status ? error.status + '-' + error.statusText : 'Server error';
        Oauth2Service.ProfileError.emit({error: error.name, error_description: errMsg});
        return Observable.throw(errMsg);
    }

}
